# Engram V0.9.8 设计方案：统一向量召回 (Unified Vector Retrieval)

> **核心理念**: **状态即实体，实体即目标**。
> 将实体 (Entity) 视为一种特殊的、具有长效状态的记忆单元，与事件 (Event) 一同纳入向量检索空间。

## 1. 背景与痛点

在 V0.9.7 及之前的版本中，Engram 的 RAG 系统仅针对 **事件 (EventNode)** 进行向量化和召回。虽然能够回顾历史，但存在以下盲区：

1.  **状态缺失**: 用户问 "Alice 现在怎么样了？"，RAG 可能会检索出 Alice 过去受伤的事件，但无法直接给出 "Alice 目前处于重伤状态" 的结论，除非这些状态被显式写在某个最近的事件里。
2.  **隐式关联弱**: 对于没有直接共同出现的实体（如 Query 中只提了 A，但需要召回与 A 关系密切的 B），纯事件检索很难建立联系。
3.  **上下文浪费**: 旧方案曾考虑 "Query -> 关键词匹配 -> 注入实体卡片"，这会导致大量无关的实体信息占用 Token，且缺乏动态性。

## 2. 核心架构：统一向量空间

V0.9.8 引入 **"Unified Vector Retrieval"** 策略，打破 Event 与 Entity 的界限。

### 2.1 实体即状态机 (Entities as State Machines)

`EntityNode` 不再仅仅是静态的资料卡，而是 **First-Class RAG Citizen**。

*   **Data Structure**:
    *   `description` (Burn-in YAML): 存储高密度的状态描述（由 LLM 动态更新）。例如：`Status: Injured; Location: Hospital; Recent: Attached by Bob`。
    *   `embedding`: 对 `description` 进行向量化。

### 2.2 混合检索 (Unified Retrieval)

当用户发起查询时，`Retriever` 会在同一个向量空间中并行检索 Event 和 Entity。

*   **Query**: "Alice 还能战斗吗？"
*   **Vector Search Scope**: `[Event Vectors] U [Entity Vectors]`
*   **Result Candidates**:
    1.  `[Event] Alice 昨天被砍伤了` (Score: 0.85)
    2.  `[Entity] Alice { status: "Critical", combat_ability: "Low" }` (Score: 0.82)
    3.  `[Event] Alice 上周买了一把剑` (Score: 0.60)

### 2.3 融合输出 (Context Injection)

检索到的 EntityNode 会被格式化为 **【实体档案】(Entity Profile)** 注入到上下文中，补充当前的状态信息，而检索到的 EventNode 继续作为 **【剧情回顾】(Memory)** 存在。

## 3. 技术实现

### 3.1 数据结构变更 (Graph)
在 `EntityNode` 中新增向量字段：
```typescript
interface EntityNode {
    // ...existing fields
    embedding?: number[];    // 对 description 的向量化
    is_embedded?: boolean;
}
```

### 3.2 向量化服务 (EmbeddingService)
升级 `EmbeddingService`，使其支持异构数据的向量化：
*   `embedEvent(event)`: 向量化 `event.summary`
*   `embedEntity(entity)`: 向量化 `entity.description`

### 3.3 检索器升级 (Retriever)
升级 `doEmbeddingSearch`：
1.  **Parallel Fetch**: 同时获取 candidate events 和 candidate entities。
2.  **Unified Scoring**: 使用余弦相似度统一打分。
3.  **Merged Ranking**: 将两者合并排序，截取 Top-K。
4.  **Format**:
    *   Event: `<event>...</event>`
    *   Entity: `【实体档案】<Name>: <Description>`

## 4. 预期效果

通过这种方式，Engram 实现了 **"历史回顾" (Events)** 与 **"状态查询" (Entities)** 的完美融合。图检索不再是外挂的关键词匹配，而是深度融合的语义召回。

> **Slogan**: Events tell the story, Entities hold the state.
