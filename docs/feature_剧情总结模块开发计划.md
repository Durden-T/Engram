# Feature: å‰§æƒ…æ€»ç»“æ¨¡å—å¼€å‘è®¡åˆ’

> **æ¨¡å—ä»£å·**: `PlotSummarizer`  
> **ç›®æ ‡**: æ„å»ºä¸€ä¸ªçº¯æ–‡æœ¬æ¨¡å¼çš„åŒå±‚è®°å¿†æ€»ç»“ç³»ç»Ÿï¼Œä½œä¸º Engram çš„åŸºç¡€åŠŸèƒ½æ¨¡å—

---

## 1. åŠŸèƒ½æ¦‚è¿°

### 1.1 æ ¸å¿ƒç›®æ ‡

ä¸ºæ²¡æœ‰å‘é‡åŒ–æ¨¡å‹çš„ç”¨æˆ·æä¾›ä¸€ä¸ª **çº¯æ–‡æœ¬åŒå±‚è®°å¿†æ€»ç»“ç³»ç»Ÿ**ï¼Œå°†å¯¹è¯å‰§æƒ…æç‚¼ä¸ºç»“æ„åŒ–çš„"å‰§æƒ…å•å…ƒ"å¹¶å­˜å…¥ SillyTavern ä¸–ç•Œä¹¦ã€‚

### 1.2 åŒå±‚è®°å¿†æœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åŒå±‚è®°å¿†ç³»ç»Ÿ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   Layer 1: æ€»ç»“å±‚ (Summarizer)                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  å¯¹è¯å— â†’ [LLM æ€»ç»“] â†’ å‰§æƒ…å•å…ƒ â†’ [æ­£åˆ™ä¿®å‰ª] â†’ ä¸–ç•Œä¹¦  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“ (Token è¶…é™æ—¶è§¦å‘)              â”‚
â”‚   Layer 2: ä¿®å‰ªå±‚ (Trimmer)                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  å·²å­˜å‚¨çš„å‰§æƒ…å•å…ƒ â†’ [LLM ç²¾ç®€åˆå¹¶] â†’ å‹ç¼©åçš„ä¸–ç•Œä¹¦æ¡ç›®  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| å±‚çº§ | åç§° | è§¦å‘æ¡ä»¶ | èŒè´£ |
|------|------|----------|------|
| **L1** | æ€»ç»“å±‚ | æ¥¼å±‚è®¡æ•°è¾¾åˆ°é˜ˆå€¼ / æ‰‹åŠ¨è§¦å‘ | å°†å¯¹è¯è’¸é¦ä¸ºå‰§æƒ…å•å…ƒ |
| **L2** | ä¿®å‰ªå±‚ | ä¸–ç•Œä¹¦ Token æ€»é‡è¶…é™ | åˆå¹¶ã€ç²¾ç®€æ—§çš„å‰§æƒ…å•å…ƒ |

### 1.3 ä¸å‘é‡åŒ–ç‰ˆæœ¬çš„å…³ç³»

```
çº¯æ–‡æœ¬æ¨¡å¼ (æœ¬æ¬¡å¼€å‘)          å‘é‡åŒ–æ¨¡å¼ (æœªæ¥æ‰©å±•)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
LLM æ€»ç»“ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LLM æ€»ç»“ (å¤ç”¨)
    â†“                              â†“
æ­£åˆ™ä¿®å‰ª                       ç»“æ„åŒ–è§£æ
    â†“                              â†“
å­˜å…¥ä¸–ç•Œä¹¦                     å­˜å…¥ DexieDB + å‘é‡åŒ–
    â†“                              â†“
LLM ä¿®å‰ªå±‚                     å›¾è°±æ£€ç´¢ + é‡æ’åº
```

---

## 2. å·²ç¡®è®¤çš„æŠ€æœ¯å†³ç­–

> [!NOTE]
> ä»¥ä¸‹é—®é¢˜å·²ä¸ç”¨æˆ·ç¡®è®¤

### âœ… ä¸–ç•Œä¹¦é›†æˆæ–¹å¼

**æ–¹æ¡ˆ**: ç”¨æˆ·å¯é€‰ï¼Œæ”¯æŒä¸¤ç§æ¨¡å¼ï¼š
1. **è§’è‰²ç»‘å®šä¸–ç•Œä¹¦** - å†™å…¥è§’è‰²å…³è”çš„ World Info
2. **èŠå¤©ç»‘å®šä¸–ç•Œä¹¦** - æ ¹æ®èŠå¤©æ–‡ä»¶åç”Ÿæˆä¸“å±ä¸–ç•Œä¹¦

### âœ… æç¤ºè¯æ¨¡æ¿

**æ–¹æ¡ˆ**: å†…ç½®é»˜è®¤æ¨¡æ¿ + ç”¨æˆ·è‡ªå®šä¹‰
- æä¾›å¼€ç®±å³ç”¨çš„æ€»ç»“/ä¿®å‰ªæ¨¡æ¿
- ç”¨æˆ·å¯ä¿®æ”¹æˆ–æ–°å»ºè‡ªå®šä¹‰æ¨¡æ¿

### âœ… Token è®¡ç®—

**æ–¹æ¡ˆ**: å¤ç”¨é…’é¦†è‡ªå¸¦çš„ `token_counter` æ¨¡å—
- æ— éœ€é¢å¤–åŠ è½½ WASM
- ä¸é…’é¦†å…¶ä»–åŠŸèƒ½ä¿æŒä¸€è‡´

### âœ… é”™è¯¯é€šçŸ¥

**æ–¹æ¡ˆ**: ä½¿ç”¨é…’é¦†åŸç”Ÿ `toastr` é€šçŸ¥ç³»ç»Ÿ
- LLM è°ƒç”¨å¤±è´¥ â†’ toastr é”™è¯¯é€šçŸ¥
- ä¸–ç•Œä¹¦å†™å…¥å¤±è´¥ â†’ toastr è­¦å‘Šé€šçŸ¥

### âœ… è®¾ç½®å­˜å‚¨

**æ–¹æ¡ˆ**: å­˜å…¥é…’é¦†çš„ `settings.json`
- è·¨æµè§ˆå™¨åŒæ­¥ç”¨æˆ·è®¾ç½®
- ä½¿ç”¨ `extension_settings.engram` å‘½åç©ºé—´

### âœ… DevLog é›†æˆ

**æ–¹æ¡ˆ**: æ‰€æœ‰å…³é”®æ“ä½œè¾“å‡ºåˆ° DevLog
- æ€»ç»“è§¦å‘ã€LLM è°ƒç”¨ã€å†™å…¥ç»“æœç­‰
- ä¾¿äºè°ƒè¯•å’Œç”¨æˆ·è¿½è¸ª

---

## 3. é€šç”¨åŠŸèƒ½æ¨¡å—

### 3.1 é¢„è§ˆä¸ä¿®è®¢ç³»ç»Ÿ (Preview & Edit)

> [!IMPORTANT]
> è¿™æ˜¯ä¸€ä¸ªå¯å¤ç”¨çš„é€šç”¨åŠŸèƒ½ï¼Œæœªæ¥çš„å¬å›ã€æ³¨å…¥ç­‰åŠŸèƒ½éƒ½å¯ä½¿ç”¨

**åŠŸèƒ½æè¿°**:
- åœ¨å†…å®¹æœ€ç»ˆå†™å…¥å‰ï¼Œå¼¹å‡ºé¢„è§ˆé¢æ¿
- ç”¨æˆ·å¯æŸ¥çœ‹ã€ç¼–è¾‘ã€ç¡®è®¤æˆ–å–æ¶ˆ
- å¯é€‰åŠŸèƒ½ï¼Œåœ¨è®¾ç½®ä¸­å¼€å…³

**UI è®¾è®¡**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“ é¢„è§ˆä¸ä¿®è®¢                          [X]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  (å¯ç¼–è¾‘çš„æ–‡æœ¬åŒºåŸŸ)                      â”‚    â”‚
â”‚  â”‚  ğŸ“œ å‰§æƒ…æ‘˜è¦:                           â”‚    â”‚
â”‚  â”‚  ç©å®¶ä¸ç¥ç§˜äººåœ¨é…’é¦†å¯†å®¤ä¼šé¢...           â”‚    â”‚
â”‚  â”‚                                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                 â”‚
â”‚  Token è®¡æ•°: 156                                â”‚
â”‚                                                 â”‚
â”‚         [å–æ¶ˆ]    [è·³è¿‡æœ¬æ¬¡]    [ç¡®è®¤å†™å…¥]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¥å£è®¾è®¡**:
```typescript
interface PreviewDialogOptions {
  title: string;
  content: string;
  editable: boolean;
  tokenCount?: number;
  onConfirm: (editedContent: string) => Promise<void>;
  onSkip?: () => void;
  onCancel?: () => void;
}

// ä½¿ç”¨ç¤ºä¾‹
await showPreviewDialog({
  title: 'æ€»ç»“é¢„è§ˆ',
  content: summaryResult,
  editable: true,
  tokenCount: countTokens(summaryResult),
  onConfirm: async (edited) => {
    await writeToWorldBook(edited);
  }
});
```

### 3.2 ä¸–ç•Œä¹¦æ“ä½œç³»ç»Ÿ (WorldBook Manager)

**èŒè´£**: å°è£…æ‰€æœ‰ä¸–ç•Œä¹¦ç›¸å…³æ“ä½œ

```typescript
interface WorldBookManager {
  // åˆ›å»º/è·å– Engram ä¸“ç”¨ä¸–ç•Œä¹¦
  getOrCreateEngramBook(chatId: string): Promise<WorldBook>;
  
  // æ¡ç›®æ“ä½œ
  createEntry(bookId: string, entry: WorldEntry): Promise<string>;
  updateEntry(bookId: string, entryId: string, content: Partial<WorldEntry>): Promise<void>;
  deleteEntry(bookId: string, entryId: string): Promise<void>;
  
  // æŸ¥è¯¢
  getEntriesByTag(bookId: string, tag: string): Promise<WorldEntry[]>;
  getTotalTokenCount(bookId: string): Promise<number>;
  
  // ç»‘å®šæ¨¡å¼
  bindToCharacter(characterId: string): Promise<void>;
  bindToChat(chatFileName: string): Promise<void>;
}
```

---

## 4. å¼€å‘è·¯çº¿å›¾

> [!IMPORTANT]
> é‡‡ç”¨æ¸è¿›å¼å¼€å‘ï¼Œå…ˆå®Œå–„åŸºç¡€è®¾æ–½ï¼Œå†æ„å»ºåŠŸèƒ½æ¨¡å—

### Phase 0: åŸºç¡€è®¾æ–½å®Œå–„

#### 0.1 APIPresets å¢å¼º

**å½“å‰çŠ¶æ€**: ä»…æ”¯æŒæ¨¡å‹æä¾›å•†é€‰æ‹©  
**ç›®æ ‡çŠ¶æ€**: å®Œæ•´çš„ API + Prompt é¢„è®¾ç®¡ç†

| å­ä»»åŠ¡ | æè¿° | çŠ¶æ€ |
|--------|------|------|
| 0.1.1 | æç¤ºè¯æ¨¡æ¿ç®¡ç†ç³»ç»Ÿ | å¾…å¼€å‘ |
| 0.1.2 | é¢„è®¾ä¸ç”¨é€”ç»‘å®šï¼ˆæ€»ç»“/ä¿®å‰ª/æ£€ç´¢ï¼‰ | å¾…è®¾è®¡ |
| 0.1.3 | å†…ç½®é»˜è®¤æ¨¡æ¿ | å¾…å¼€å‘ |
| 0.1.4 | é¢„è®¾å¯¼å…¥å¯¼å‡º | å¾…å¼€å‘ |

**æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿè®¾è®¡**:
```typescript
interface PromptTemplate {
  id: string;
  name: string;
  category: 'summarize' | 'trim' | 'retrieve' | 'custom';
  isBuiltIn: boolean;           // æ˜¯å¦ä¸ºå†…ç½®æ¨¡æ¿
  systemPrompt: string;
  userPromptTemplate: string;   // æ”¯æŒå˜é‡æ’æ§½ {{chatHistory}}, {{context}}
  outputFormat?: 'json' | 'markdown' | 'plain';
  variables: string[];          // å¯ç”¨å˜é‡åˆ—è¡¨
}

interface APIPreset {
  id: string;
  name: string;
  provider: 'openai' | 'anthropic' | 'ollama' | 'openrouter' | 'custom';
  endpoint: string;
  apiKey?: string;
  model: string;
  // æ–°å¢: ç»‘å®šçš„æç¤ºè¯æ¨¡æ¿
  boundTemplates: {
    summarize?: string; // PromptTemplate ID
    trim?: string;
  };
}
```

#### 0.2 SillyTavern äº‹ä»¶æ€»çº¿

**ç›®æ ‡**: ç›‘å¬é…’é¦†äº‹ä»¶ï¼Œè·å–å¯¹è¯ä¸Šä¸‹æ–‡

| å­ä»»åŠ¡ | æè¿° | çŠ¶æ€ |
|--------|------|------|
| 0.2.1 | æ¥¼å±‚è®¡æ•°ç›‘å¬ (`MESSAGE_RECEIVED`) | å¾…è°ƒç ” |
| 0.2.2 | èŠå¤©åˆ‡æ¢ç›‘å¬ (`CHAT_CHANGED`) | å¾…è°ƒç ” |
| 0.2.3 | è·å–å½“å‰å¯¹è¯å†å² API | å¾…è°ƒç ” |
| 0.2.4 | Token è®¡æ•° API (`token_counter`) | å¾…è°ƒç ” |
| 0.2.5 | Toastr é€šçŸ¥ API | å¾…è°ƒç ” |

#### 0.3 ä¸–ç•Œä¹¦ API å°è£…

| å­ä»»åŠ¡ | æè¿° | çŠ¶æ€ |
|--------|------|------|
| 0.3.1 | ä¸–ç•Œä¹¦ CRUD API | å¾…è°ƒç ” |
| 0.3.2 | WorldBookManager å®ç° | å¾…å¼€å‘ |
| 0.3.3 | è§’è‰²/èŠå¤©ç»‘å®šé€»è¾‘ | å¾…å¼€å‘ |

#### 0.4 è®¾ç½®æŒä¹…åŒ–

| å­ä»»åŠ¡ | æè¿° | çŠ¶æ€ |
|--------|------|------|
| 0.4.1 | æ¥å…¥é…’é¦† settings.json | å¾…è°ƒç ” |
| 0.4.2 | Engram è®¾ç½® Schema å®šä¹‰ | å¾…å¼€å‘ |

---

### Phase 1: æ€»ç»“å±‚ (Summarizer)

#### 1.1 æ ¸å¿ƒæµç¨‹

```mermaid
sequenceDiagram
    participant ST as SillyTavern
    participant EB as EventBus
    participant Sum as Summarizer
    participant LLM as LLM Service
    participant Trim as RegexTrimmer
    participant Preview as PreviewDialog
    participant WB as WorldBook
    participant Log as DevLog

    ST->>EB: MESSAGE_RECEIVED (æ¥¼å±‚ +1)
    EB->>Sum: æ£€æŸ¥æ˜¯å¦è¾¾åˆ°é˜ˆå€¼
    Sum->>Log: è®°å½•è§¦å‘äº‹ä»¶
    alt è¾¾åˆ°é˜ˆå€¼
        Sum->>ST: è·å–æœ€è¿‘ N æ¡å¯¹è¯
        Sum->>LLM: è°ƒç”¨æ€»ç»“ Prompt
        LLM-->>Sum: è¿”å›å‰§æƒ…æ‘˜è¦
        Sum->>Trim: æ­£åˆ™æ¸…æ´—æ–‡æœ¬
        Trim-->>Sum: è¿”å›æ¸…æ´—åæ–‡æœ¬
        alt é¢„è§ˆæ¨¡å¼å¼€å¯
            Sum->>Preview: æ˜¾ç¤ºé¢„è§ˆé¢æ¿
            Preview-->>Sum: ç”¨æˆ·ç¡®è®¤/ç¼–è¾‘
        end
        Sum->>WB: åˆ›å»ºä¸–ç•Œä¹¦æ¡ç›®
        Sum->>Log: è®°å½•å†™å…¥ç»“æœ
    end
```

#### 1.2 æ­£åˆ™ä¿®å‰ªè§„åˆ™

```typescript
const TRIM_RULES = [
  // ç§»é™¤å¤šä½™ç©ºè¡Œ
  { pattern: /\n{3,}/g, replacement: '\n\n' },
  // ç§»é™¤è¡Œé¦–è¡Œå°¾ç©ºç™½
  { pattern: /^\s+|\s+$/gm, replacement: '' },
  // ç§»é™¤ Markdown ä»£ç å—æ ‡è®°ï¼ˆä¿ç•™å†…å®¹ï¼‰
  { pattern: /```\w*\n?/g, replacement: '' },
  // ç»Ÿä¸€å¼•å·
  { pattern: /[""]/g, replacement: '"' },
  // å¯æ‰©å±•...
];
```

#### 1.3 ä¸–ç•Œä¹¦æ¡ç›®æ ¼å¼

```
---
ğŸ• æ—¶é—´: ç¬¬3å¤© ä¸‹åˆ
ğŸ“ åœ°ç‚¹: é…’é¦†äºŒæ¥¼
ğŸ”‘ å…³é”®è¯: å¯†è°ˆ, é’¥åŒ™, ç¥ç§˜äºº
---
ğŸ“œ å‰§æƒ…æ‘˜è¦:
ç©å®¶ä¸ç¥ç§˜äººåœ¨é…’é¦†å¯†å®¤ä¼šé¢ï¼Œè·å¾—äº†ä¸€æŠŠç”Ÿé”ˆçš„é’¥åŒ™...
```

---

### Phase 2: ä¿®å‰ªå±‚ (Trimmer)

#### 2.1 è§¦å‘æœºåˆ¶

```typescript
interface TrimmerConfig {
  enabled: boolean;
  tokenThreshold: number;  // ä¾‹å¦‚ 2000 tokens
  mergeStrategy: 'chronological' | 'importance';
  keepRecentCount: number; // ä¿ç•™æœ€è¿‘ N æ¡ä¸åˆå¹¶
}
```

#### 2.2 æ ¸å¿ƒé€»è¾‘

1. ç›‘æ§ä¸–ç•Œä¹¦ä¸­ Engram åˆ›å»ºçš„æ¡ç›®æ€» Token æ•°
2. è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œé€‰å–æœ€æ—§çš„ M æ¡è¿›è¡Œåˆå¹¶
3. è°ƒç”¨ä¿®å‰ª LLMï¼Œè¾“å‡ºä¸€æ¡ç²¾ç®€åçš„åˆå¹¶æ¡ç›®
4. åˆ é™¤åŸæ¡ç›®ï¼Œæ’å…¥æ–°æ¡ç›®
5. è¾“å‡ºæ—¥å¿—åˆ° DevLog

---

### Phase 3: è®¾ç½®ç•Œé¢

#### 3.1 è®¾ç½®é¡¹

| è®¾ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| è§¦å‘æ¨¡å¼ | select | `manual` | æ‰‹åŠ¨ / è‡ªåŠ¨ / æ··åˆ |
| æ¥¼å±‚é—´éš” | number | 10 | æ¯éš” N æ¡å¯¹è¯è‡ªåŠ¨è§¦å‘ |
| ä½¿ç”¨çš„ API é¢„è®¾ | select | - | é€‰æ‹© APIPresets ä¸­çš„é¢„è®¾ |
| ä¸–ç•Œä¹¦ç»‘å®šæ¨¡å¼ | select | `chat` | è§’è‰²ç»‘å®š / èŠå¤©ç»‘å®š |
| Token ä¸Šé™ | number | 2000 | è§¦å‘ä¿®å‰ªå±‚çš„é˜ˆå€¼ |
| ä¿ç•™æœ€è¿‘æ¡ç›®æ•° | number | 3 | ä¿®å‰ªæ—¶è·³è¿‡çš„æœ€æ–°æ¡ç›® |
| å¯ç”¨é¢„è§ˆ | checkbox | true | å†™å…¥å‰æ˜¾ç¤ºé¢„è§ˆé¢æ¿ |

#### 3.2 å­˜å‚¨ç»“æ„

```typescript
// å­˜å…¥ settings.json çš„ç»“æ„
interface EngramSettings {
  summarizer: {
    triggerMode: 'manual' | 'auto' | 'hybrid';
    floorInterval: number;
    apiPresetId: string;
    worldBookBindMode: 'character' | 'chat';
    enablePreview: boolean;
  };
  trimmer: {
    enabled: boolean;
    tokenThreshold: number;
    keepRecentCount: number;
  };
}
```

#### 3.3 UI ä½ç½®

åœ¨ç°æœ‰ `Settings` è§†å›¾ä¸­æ–°å¢ `SummarizerSection`:

```
Settings/
â”œâ”€â”€ index.tsx
â””â”€â”€ sections/
    â”œâ”€â”€ GeneralSection.tsx
    â”œâ”€â”€ StorageSection.tsx
    â””â”€â”€ SummarizerSection.tsx  â† æ–°å¢
```

---

### Phase 4: æ€»ç»“æ§åˆ¶ UI

#### 4.1 Brain è§†å›¾æ”¹é€ 

åœ¨ `Brain/Summarize` é¡µé¢æ·»åŠ ï¼š

- **çŠ¶æ€æ˜¾ç¤º**: å½“å‰æ¥¼å±‚è®¡æ•°ã€è·ç¦»ä¸‹æ¬¡è‡ªåŠ¨è§¦å‘çš„å‰©ä½™
- **æ‰‹åŠ¨è§¦å‘æŒ‰é’®**: ç«‹å³æ‰§è¡Œæ€»ç»“
- **é¢„è§ˆåŒºåŸŸ**: æ˜¾ç¤ºå°†è¦æ€»ç»“çš„å¯¹è¯å—
- **å†å²è®°å½•**: å·²ç”Ÿæˆçš„å‰§æƒ…å•å…ƒåˆ—è¡¨

---

## 5. å¼€å‘ä¼˜å…ˆçº§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Priority 1: è°ƒç ”é˜¶æ®µ                                        â”‚
â”‚  â”œâ”€â”€ è°ƒç ” SillyTavern äº‹ä»¶ç³»ç»Ÿ                               â”‚
â”‚  â”œâ”€â”€ è°ƒç ”ä¸–ç•Œä¹¦ API                                          â”‚
â”‚  â”œâ”€â”€ è°ƒç ” token_counter ç”¨æ³•                                 â”‚
â”‚  â””â”€â”€ è°ƒç ” settings.json å­˜å‚¨æ–¹å¼                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Priority 2: åŸºç¡€è®¾æ–½                                        â”‚
â”‚  â”œâ”€â”€ APIPresets æç¤ºè¯æ¨¡æ¿ç³»ç»Ÿ                               â”‚
â”‚  â”œâ”€â”€ APIPresets UI å¢å¼º                                     â”‚
â”‚  â””â”€â”€ äº‹ä»¶æ€»çº¿å°è£… (STBridge)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Priority 3: æ ¸å¿ƒåŠŸèƒ½                                        â”‚
â”‚  â”œâ”€â”€ WorldBookManager å®ç°                                  â”‚
â”‚  â”œâ”€â”€ Summarizer æ ¸å¿ƒé€»è¾‘                                    â”‚
â”‚  â”œâ”€â”€ PreviewDialog é€šç”¨ç»„ä»¶                                 â”‚
â”‚  â””â”€â”€ Settings æŒä¹…åŒ–                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Priority 4: UI ä¸ä½“éªŒ                                       â”‚
â”‚  â”œâ”€â”€ Brain/Summarize UI                                     â”‚
â”‚  â”œâ”€â”€ Settings/SummarizerSection                             â”‚
â”‚  â””â”€â”€ DevLog é›†æˆ                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Priority 5: æ‰©å±•åŠŸèƒ½                                        â”‚
â”‚  â””â”€â”€ Trimmer ä¿®å‰ªå±‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. ä¸‹ä¸€æ­¥è¡ŒåŠ¨

- [x] ç¡®è®¤æŠ€æœ¯å†³ç­–
- [x] **è°ƒç ” SillyTavern æºç å’Œæ–‡æ¡£**
  - [x] äº‹ä»¶ç³»ç»Ÿ (`eventSource`, `event_types`)
  - [x] ä¸–ç•Œä¹¦ API
  - [x] Token è®¡æ•° (`tokenizers`)
  - [x] è®¾ç½®å­˜å‚¨ (`extension_settings`)
  - [x] Toastr é€šçŸ¥
- [x] ç»†åŒ– APIPresets å¢å¼ºçš„å…·ä½“éœ€æ±‚
- [x] æ­å»ºåŸºç¡€æ¡†æ¶ (Processing, APIPresets, Prompt System)

---

*æ–‡æ¡£ç‰ˆæœ¬: v0.3*  
*æ›´æ–°æ—¥æœŸ: 2025-12-28*  
*çŠ¶æ€: åŸºç¡€æ¡†æ¶æ­å»ºå®Œæˆï¼Œè¿›å…¥æ ¸å¿ƒåŠŸèƒ½å¼€å‘*
