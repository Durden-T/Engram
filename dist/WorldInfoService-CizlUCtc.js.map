{"version":3,"file":"WorldInfoService-CizlUCtc.js","sources":["../src/infrastructure/tavern/WorldInfoService.ts"],"sourcesContent":["/**\n * WorldInfoService - SillyTavern 世界书服务封装\n * \n * 提供世界书操作和 Token 计数功能\n */\n\n/** 世界书条目位置类型 */\nexport type WorldInfoPosition =\n    | 'before_character_definition'\n    | 'after_character_definition'\n    | 'before_example_messages'\n    | 'after_example_messages'\n    | 'at_depth';\n\n/** 世界书条目策略类型 */\nexport type WorldInfoStrategy = 'constant' | 'selective' | 'vectorized';\n\n/** 世界书条目角色 */\nexport type WorldInfoRole = 'system' | 'assistant' | 'user';\n\n/** 创建世界书条目的参数 */\nexport interface CreateWorldInfoEntryParams {\n    /** 条目名称 */\n    name: string;\n    /** 条目内容 */\n    content: string;\n    /** 是否启用 */\n    enabled?: boolean;\n    /** 是否常亮（蓝灯） */\n    constant?: boolean;\n    /** 触发关键词 */\n    keys?: string[];\n    /** 次要关键词 */\n    keysSecondary?: string[];\n    /** 位置类型 */\n    position?: WorldInfoPosition;\n    /** 角色 */\n    role?: WorldInfoRole;\n    /** 深度 */\n    depth?: number;\n    /** 排序权重 */\n    order?: number;\n    /** 触发概率 */\n    probability?: number;\n}\n\n/** 世界书条目 */\nexport interface WorldInfoEntry {\n    uid: number;\n    name: string;\n    content: string;\n    enabled: boolean;\n    constant: boolean;\n    keys: string[];\n    position: WorldInfoPosition;\n    depth: number;\n    order: number;\n    tokenCount?: number;\n}\n\n/** 世界书 Token 统计 */\nexport interface WorldInfoTokenStats {\n    totalTokens: number;\n    entryCount: number;\n    entries: Array<{ name: string; tokens: number }>;\n}\n\n/**\n * 获取 SillyTavern 的 tokenizers 模块\n */\nasync function getTokenCountAsync(text: string): Promise<number> {\n    try {\n        // @ts-expect-error - SillyTavern 全局对象\n        const SillyTavern = window.SillyTavern;\n        if (SillyTavern?.getContext) {\n            const context = SillyTavern.getContext();\n            if (context?.getTokenCountAsync) {\n                return await context.getTokenCountAsync(text);\n            }\n        }\n\n        // fallback: 字符估算 (约 4 字符 = 1 token)\n        return Math.ceil(text.length / 4);\n    } catch {\n        console.warn('[Engram] WorldInfoService: 无法使用酒馆 Token 计数，使用估算');\n        return Math.ceil(text.length / 4);\n    }\n}\n\n/**\n * 获取 TavernHelper API (如果可用)\n */\nfunction getTavernHelper(): {\n    getOrCreateChatWorldbook?: (mode: 'current' | 'character') => Promise<string>;\n    getWorldbook?: (name: string) => Promise<unknown[]>;\n    createWorldbookEntries?: (name: string, entries: unknown[]) => Promise<void>;\n    replaceWorldbook?: (name: string, entries: unknown[]) => Promise<void>;\n} | null {\n    try {\n        // @ts-expect-error - TavernHelper 全局对象\n        return window.TavernHelper || null;\n    } catch {\n        return null;\n    }\n}\n\n/**\n * WorldInfoService 类\n * 提供世界书操作和 Token 计数功能\n */\nexport class WorldInfoService {\n    /**\n     * 计算文本的 Token 数量\n     * @param text 文本内容\n     */\n    static async countTokens(text: string): Promise<number> {\n        return getTokenCountAsync(text);\n    }\n\n    /**\n     * 批量计算多段文本的 Token 数量\n     * @param texts 文本数组\n     */\n    static async countTokensBatch(texts: string[]): Promise<number[]> {\n        return Promise.all(texts.map(t => getTokenCountAsync(t)));\n    }\n\n    /**\n     * 获取当前聊天的绑定世界书名称\n     * 如果不存在则创建\n     */\n    static async getChatWorldbook(): Promise<string | null> {\n        const helper = getTavernHelper();\n        if (helper?.getOrCreateChatWorldbook) {\n            try {\n                return await helper.getOrCreateChatWorldbook('current');\n            } catch (e) {\n                console.error('[Engram] WorldInfoService: 获取聊天世界书失败', e);\n                return null;\n            }\n        }\n        console.warn('[Engram] WorldInfoService: TavernHelper 不可用');\n        return null;\n    }\n\n    /**\n     * 获取世界书的所有条目\n     * @param worldbookName 世界书名称\n     */\n    static async getEntries(worldbookName: string): Promise<WorldInfoEntry[]> {\n        const helper = getTavernHelper();\n        if (!helper?.getWorldbook) {\n            console.warn('[Engram] WorldInfoService: TavernHelper 不可用');\n            return [];\n        }\n\n        try {\n            const entries = await helper.getWorldbook(worldbookName);\n            // 简化转换，实际结构可能更复杂\n            return (entries as unknown[]).map((e: unknown) => {\n                const entry = e as Record<string, unknown>;\n                return {\n                    uid: entry.uid as number || 0,\n                    name: entry.name as string || '',\n                    content: entry.content as string || '',\n                    enabled: entry.enabled as boolean ?? true,\n                    constant: entry.constant as boolean ?? false,\n                    keys: (entry.key as string[]) || [],\n                    position: (entry.position as WorldInfoPosition) || 'before_character_definition',\n                    depth: entry.depth as number || 0,\n                    order: entry.order as number || 100,\n                };\n            });\n        } catch (e) {\n            console.error('[Engram] WorldInfoService: 获取世界书条目失败', e);\n            return [];\n        }\n    }\n\n    /**\n     * 创建新的世界书条目\n     * @param worldbookName 世界书名称\n     * @param params 条目参数\n     */\n    static async createEntry(worldbookName: string, params: CreateWorldInfoEntryParams): Promise<boolean> {\n        const helper = getTavernHelper();\n        if (!helper?.createWorldbookEntries) {\n            console.warn('[Engram] WorldInfoService: TavernHelper 不可用');\n            return false;\n        }\n\n        try {\n            const entry = {\n                name: params.name,\n                content: params.content,\n                enabled: params.enabled ?? true,\n                strategy: {\n                    type: params.constant ? 'constant' : 'selective',\n                    keys: params.keys || [],\n                    keys_secondary: {\n                        logic: 'and_any',\n                        keys: params.keysSecondary || [],\n                    },\n                    scan_depth: 'same_as_global',\n                },\n                position: {\n                    type: params.position || 'before_character_definition',\n                    role: params.role || 'system',\n                    depth: params.depth || 0,\n                    order: params.order || 100,\n                },\n                probability: params.probability || 100,\n            };\n\n            await helper.createWorldbookEntries(worldbookName, [entry]);\n            return true;\n        } catch (e) {\n            console.error('[Engram] WorldInfoService: 创建世界书条目失败', e);\n            return false;\n        }\n    }\n\n    /**\n     * 获取世界书的 Token 统计\n     * @param worldbookName 世界书名称\n     */\n    static async getWorldbookTokenStats(worldbookName: string): Promise<WorldInfoTokenStats> {\n        const entries = await this.getEntries(worldbookName);\n\n        const entriesWithTokens = await Promise.all(\n            entries.map(async (e) => ({\n                name: e.name,\n                tokens: await this.countTokens(e.content),\n            }))\n        );\n\n        const totalTokens = entriesWithTokens.reduce((sum, e) => sum + e.tokens, 0);\n\n        return {\n            totalTokens,\n            entryCount: entries.length,\n            entries: entriesWithTokens,\n        };\n    }\n\n    /**\n     * 检查 WorldInfoService 是否可用\n     */\n    static isAvailable(): boolean {\n        return getTavernHelper() !== null;\n    }\n\n    /**\n     * 检查 Token 计数是否使用酒馆原生 API\n     */\n    static async isNativeTokenCountAvailable(): Promise<boolean> {\n        try {\n            // @ts-expect-error - SillyTavern 全局对象\n            const SillyTavern = window.SillyTavern;\n            if (SillyTavern?.getContext) {\n                const context = SillyTavern.getContext();\n                return typeof context?.getTokenCountAsync === 'function';\n            }\n            return false;\n        } catch {\n            return false;\n        }\n    }\n\n    /**\n     * 获取所有激活的世界书条目内容（用于总结）\n     * 使用酒馆原生 getWorldInfoPrompt 进行扫描，获取所有激活的条目\n     * 支持：蓝灯（常驻）+ 绿灯（关键词触发）\n     * \n     * @param chatMessages 可选，用于关键词扫描的聊天消息\n     * @returns 格式化后的世界书内容字符串\n     */\n    static async getActivatedWorldInfo(chatMessages?: string[]): Promise<string> {\n        try {\n            // 使用运行时动态导入绕过 Rollup 的静态分析\n            const importPath = '/scripts/world-info.js';\n            // @ts-expect-error - 动态导入酒馆模块\n            const worldInfoModule = await (new Function('path', 'return import(path)'))(importPath);\n            const getWorldInfoPrompt = worldInfoModule?.getWorldInfoPrompt;\n\n            if (typeof getWorldInfoPrompt !== 'function') {\n                console.warn('[Engram] WorldInfoService: getWorldInfoPrompt 不可用，回退到常驻条目');\n                return this.getConstantWorldInfo();\n            }\n\n            // 获取聊天消息用于关键词扫描\n            let messages = chatMessages;\n            if (!messages || messages.length === 0) {\n                // 从酒馆上下文获取聊天记录\n                // @ts-expect-error - 酒馆全局对象\n                const context = window.SillyTavern?.getContext?.();\n                if (context?.chat && Array.isArray(context.chat)) {\n                    messages = context.chat.map((m: { mes?: string }) => m.mes || '').reverse();\n                }\n            }\n\n            if (!messages || messages.length === 0) {\n                console.warn('[Engram] WorldInfoService: 无聊天消息，回退到常驻条目');\n                return this.getConstantWorldInfo();\n            }\n\n            // 调用世界书扫描（isDryRun=true 不触发额外事件）\n            const maxContext = 8192; // 默认上下文大小\n            const result = await getWorldInfoPrompt(messages, maxContext, true, {\n                trigger: 'normal'\n            });\n\n            // 合并 before 和 after 位置的世界书内容\n            const worldInfo = [\n                result?.worldInfoBefore || '',\n                result?.worldInfoAfter || ''\n            ].filter(Boolean).join('\\n\\n').trim();\n\n            if (worldInfo) {\n                console.debug(`[Engram] WorldInfoService: 获取到激活的世界书内容 (${worldInfo.length} 字符)`);\n            }\n\n            return worldInfo;\n        } catch (e) {\n            console.warn('[Engram] WorldInfoService: 获取世界书失败，回退到常驻条目', e);\n            return this.getConstantWorldInfo();\n        }\n    }\n\n    /**\n     * 获取常驻激活的世界书条目（蓝灯）\n     * 作为 getActivatedWorldInfo 的回退方案\n     */\n    private static async getConstantWorldInfo(): Promise<string> {\n        try {\n            const importPath = '/scripts/world-info.js';\n            // @ts-expect-error - 动态导入酒馆模块\n            const worldInfoModule = await (new Function('path', 'return import(path)'))(importPath);\n            const getSortedEntries = worldInfoModule?.getSortedEntries;\n\n            if (typeof getSortedEntries !== 'function') {\n                return '';\n            }\n\n            const entries = await getSortedEntries();\n            if (!entries || !Array.isArray(entries)) {\n                return '';\n            }\n\n            const constantEntries = entries.filter((e: {\n                constant?: boolean;\n                disable?: boolean;\n                content?: string;\n            }) => e.constant === true && e.disable !== true && e.content);\n\n            if (constantEntries.length === 0) {\n                return '';\n            }\n\n            console.debug(`[Engram] WorldInfoService: 回退获取 ${constantEntries.length} 个常驻条目`);\n            return constantEntries.map((e: { content: string }) => e.content).join('\\n\\n');\n        } catch {\n            return '';\n        }\n    }\n}\n\nexport default WorldInfoService;\n"],"names":["getTokenCountAsync","text","SillyTavern","context","getTavernHelper","WorldInfoService","texts","helper","e","worldbookName","entry","params","entries","entriesWithTokens","sum","chatMessages","_a","_b","worldInfoModule","getWorldInfoPrompt","messages","m","result","worldInfo","getSortedEntries","constantEntries"],"mappings":"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"}